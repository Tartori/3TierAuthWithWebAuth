%!TEX program = lualatex
\documentclass[a4paper, 11pt]{scrartcl}

\usepackage{csquotes}

\usepackage{kpfonts}
\usepackage{geometry}
\usepackage{hyperref}
\usepackage{pgf-umlsd}
\usetikzlibrary{calc}
\usepackage{polyglossia}
\setdefaultlanguage{english}
\usepackage[backend=biber, style=ieee]{biblatex}
\addbibresource{paper.bib}
\usepackage{graphicx}
\begin{document}
\title{Web Authn Implementation}
\date{\today} 
\author{ Julian Stampfli (\texttt{julianjimmy.stampfli@students.bfh.ch}) }
\maketitle
\setcounter{tocdepth}{2}
\tableofcontents
\clearpage

\section{Introduction}

Passwords are the most common used way to authenticate a user. They are easy to implement and have been used since the beginning of the internet. People are used to passwords and use them everywhere, but most of them use weak ones. Remembering strong passwords is not easy, thus, most opt for easier passwords or password reuse them. The newest recommendations from the NIST are actually to use very long passwords that make sense for a human. For isntance a sentence in a fictional language or with slang words. An appropriate password would then look something like `awsumfurrycybercat', but not that. \cite{nist:pw:blog}

Even when user use strong passwords with this it is hard to remember a new password for every site. Thus, they will reuse passwords for multiple sites. Password reuse can lead to dangerous password credential stuffing attacks where the password that was leaked from one service can be used to access another service. \cite{panda:pwreuse, xkcd:pwreuse} Those are two weaknesses that passwords always had. Firstly, used passwords are generally too weak, secondly, they are reused for multiple services. 

FIDO2 is a specification that aims to increase security for end users by eliminating the weaknesses that come with passwords. The main advantages are strong privacy, privacy protection, multiple choices, cost-efficiency and a layered approach. It tries to do that by using secure authenticators that are used instead of a password. \cite{yubico:whatIsFido2} 

The main force behind FIDO2 is the FIDO Alliance. Some noticable members are Microsoft, Google and Yubico. Microsoft for instance wants to use FIDO2 for the windows hello login. \cite{yubico:ms} With that force behind it it has been adopted in all major web browser. \cite{fido:browser} There are also already authenticators available from yubico that can be used. \cite{yubico:yubikey5}

This paper discusses the implementation for the replying party when the user already has a fido2 authenticator.

\section{FIDO2}

FIDO2 is an authentication standart wich uses public key cryptography to authenticate an user. Compared to a password the user doesn't prove that he knows something but that he has something that he previously has registered with the application. This authenticator is an external device that interacts with the application through a protocol called CTAP. CTAP is also part of the FIDO2 specification but this paper does not go into detail of how this protocol works. \cite{ctap}

The WebAuthn specification forms the second part of FIDO2. This part deals with the Application that wants to authenticate an user. It contains two steps. Attestation which deals with registering a new user and assertion which handles the authentication of an existing user. Both functions are explained in the Section \ref{sec:replying_party}.

\subsection{Main Ideas}

Traditionally, when a user wants to register or authenticate, he supplies the application with a password. A shared secret that only the user is supposed to know. We already discussed how passwords usually lead to a weak authentication. This issue was usually solved by adding a second factor to the authentication. With FIDO U2F this second factor would be very strong and the authentication would be resilient against big attacks. However, many sites offer weaker forms of second factor authentication like codes via e-mail or phone. Both of those methods are weak to message interception where an attacker intercepts the message before the end user recieves it. \cite{smsweak}

By using certified authenticators, FIDO2 makes sure that a user needs to have access to his authenticator and be present when the authentication is triggered. With this an attacker could still steal the physical authenticator and authenticate with it. However, this kind of physical attack can't be used to steal the authenticator for a large group of people. Additionally once the user notices that his authenticator has been stolen, he can inform the service provider and disable this authenticator for future authentications. Additionally to secure authenticators that are simply left in the USB slot of a machine, FIDO2 requires the user to be present during the authentication. With this an attacker can't simply put some malware on the users computer and trigger the login. 

\subsection{Authenticator}

\subsubsection{Level 1}
\subsubsection{Level 2}
\subsubsection{Level 3}
\subsubsection{Level 3+}


\subsection{FIDO2 vs FIDO U2F}

\section{Replying Party Reference Implementation}
\label{sec:replying_party}

The replying party is one of the main components of the FIDO2 standart and the main component of this paper. It includes a sample implementation of the replying party meant as a reference. This part will deal with the two phases attestation and authentication. First there is a short section dealing with the setup of the reference code.

\subsection{Environment}

The reference code is written in Java and uses Maven for dependency management. To get the REST API set up Spring Boot is used such that most of the non relevant code of setting up controllers etc could be spared. The data from the registrations are stored in a set to decrease the non-relevant code even more. There are some data classes that mostly represent data that is used within the application. 

The frontend part is from the FIDO Alliance demo \cite{fido:demo}. Additionally some inspiration was taken from the Yubico implementation of the Java-Webauthn-Server also available on Github \cite{yubico:webauthn:server}. 

For testing the YubiKey 5 was used \cite{yubico:yubikey5} which is reflected in the code. There are multiple ways with which the the standart can be implemented. Only the way to implement it with a yubikey 5 is available in the reference code. The other ways are discussed in their relative paragraphs.

The relevant classes are the LoginController, the RegistrationController and the AuthenticatorDataParser. Those are nice references for when one wants to implement the replying party oneself. Those classes are displayed in depth in the following sections.

\subsection{Registration / Attestation}

The registration which is reflected in the RegistrationController represents the process a user has to go through to register with the application using a FIDO2 capable token. It consists of two main steps. First the replying party has to create a JSON that will be accepted by the token in the CTAP protocol as a valid challenge. After the response from the client the response endpoint need to validate the input from the authenticator. This can be seen in Figure \ref{fig:user_registration}

\begin{figure}
  \centering
  \begin{sequencediagram}
    \newthread{U}{User}{}
    \newinst[1]{T}{Token}{}
    \newinst[2.5]{B}{Browser}{}
    \newinst[3]{R}{Replying Party}{}
    \begin{call}{U}{Register}{B}{}
      \begin{call} {B}{/create(user)}{R}{makeCredentialJson}
      \end{call} 
      \begin{call} {B}{navigator.create}{T}{createResponse}
        \begin{call}{T}{activate}{U}{activation}
        \end{call}
      \end{call} 
      \begin{call} {B}{/response(createResponse)}{R}{username}
      \end{call} 
    \end{call}
  \end{sequencediagram}
  \caption{User Registration}
  \label{fig:user_registration}
\end{figure}

\subsubsection{Create registration}

\subsubsection{Verify registration}

\paragraph{Step1}
\paragraph{Step2}
\paragraph{Step3}
\paragraph{Step4}
\paragraph{Step5}
\paragraph{Step6}
\paragraph{Step7}
\paragraph{Step8}
\paragraph{Step9}
\paragraph{Step10}
\paragraph{Step11}
\paragraph{Step12}
\paragraph{Step13}
\paragraph{Step14}
\paragraph{Step15}
\paragraph{Step16}
\paragraph{Step17}
\paragraph{Step18}
\paragraph{Step19}

\subsubsection{Summary}

\subsection{Login / Authentication}

\subsubsection{Create registration}

\subsubsection{Verify registration}

\paragraph{Step1}
\paragraph{Step2}
\paragraph{Step3}
\paragraph{Step4}
\paragraph{Step5}
\paragraph{Step6}
\paragraph{Step7}
\paragraph{Step8}
\paragraph{Step9}
\paragraph{Step10}
\paragraph{Step11}
\paragraph{Step12}
\paragraph{Step13}
\paragraph{Step14}
\paragraph{Step15}
\paragraph{Step16}
\subsubsection{Summary}


\section{Conclusion}



\clearpage
%% Print the bibibliography and add the section to the table of content
\printbibliography[heading=bibintoc]

\end{document}
